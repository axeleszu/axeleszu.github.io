<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sopa de Letras</title>
    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SOPA">
    <link rel="apple-touch-icon" href="./ico/152.png">
    <link rel="icon" type="image/png" href="./sopa-ico.png">
    <style>
        :root {
            --cell-amount: 20;
            --celda-size: calc((100vw - 5.5rem) / var(--cell-amount));
        }

        body {
            font-family: monospace;
            margin: 0;
            padding: 1em;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            color: #333;
        }

        nav {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            text-align: center;
            margin-bottom: 1em;
            align-items: center;
        }

        #tableroDiv {
            display: inline-block;
            border: 2px solid #555;
            background-color: #fff;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
            touch-action: none;
        }

        .fila {
            display: flex;
        }

        .celda {
            width: var(--celda-size);
            height: var(--celda-size);
            max-width: 25px;
            max-height: 25px;
            border: 1px solid #ddd;
            text-align: center;
            text-transform: uppercase;
            font-size: clamp(10px, 1.8vw, 1rem);
            line-height: clamp(10px, 3.6vw, 2rem);
            font-weight: bold;
            color: #444;
            transition: background-color 0.1s;
        }

        .celda.seleccionado {
            background-color: #FFD700;
        }

        .celda.encontrado {
            background-color: #90EE90;
            color: #333;
        }

        #listaPalabras ul li.encontrado-lista {
            text-decoration: line-through;
            color: #888;
        }


        #listaPalabras {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #listaPalabras ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        #musicToggleButton {
            background: transparent;
            border: 0;
        }
    </style>
</head>

<body>
    <h2>Sopa de Letras</h2>
    <nav>
        <select id="sopaSizeSelect">
            <option value="15">15x15</option>
            <option value="20">20x20</option>
            <option value="25">25x25</option>
            <option value="30">30x30</option>
        </select>
        <p>Ganadas: <span id="ganadasSpan">0</span></p>
        <p><button id="musicToggleButton" type="button">锔</button></p>
    </nav>
    <div id="tableroDiv"></div>
    <div id="listaPalabras">

        <ul id="palabrasUL"></ul>
    </div>
    <dialog id="dialog">
        <h1>隆Ganaste!</h1>
        <p>隆Felicidades! Has encontrado todas las palabras.</p>
        <button type="button">Volver a empezar</button>
    </dialog>

    <script>
        sopaLetras = {};

        const tableroDiv = document.getElementById("tableroDiv");
        const palabrasULElement = document.getElementById("palabrasUL");
        const dialog = document.getElementById('dialog');
        const restartButton = dialog.querySelector('button');
        const sizeSelect = document.getElementById("sopaSizeSelect");
        const ganadasSpan = document.getElementById("ganadasSpan");
        const musicToggleButton = document.getElementById("musicToggleButton");

        // Music Player
        const audioel = document.createElement("audio");
        musicToggleButton.appendChild(audioel);


        const music = ["background-music-413276.mp3",
            "lofi-background-music-405228.mp3",
            "soft-background-music-409193.mp3",
            "just-relax-11157.mp3",
            "please-calm-my-mind-125566.mp3",
            "youtube-background-music-lofi-398315.mp3"]

        audioel.id = "musicPlayer";
        audioel.src = `./music/${music[Math.floor(Math.random() * music.length)]}`;
        audioel.volume = 0.2;

        musicToggleButton.addEventListener('click', toggleMusic);
        function toggleMusic() {
            if (audioel.paused) {
                audioel.play();
                musicToggleButton.textContent = '革';
            } else {
                audioel.pause();
                musicToggleButton.textContent = '讹';
            }
        }

        audioel.onended = function () {
            audio.src = `music/${music[Math.floor(Math.random() * music.length)]}`;
            audio.play();
        };

        if (!localStorage.getItem("sopaLetras")) {
            sopaLetras = {
                size: 10,
                wins: 0
            }
        } else {
            sopaLetras = JSON.parse(localStorage.getItem("sopaLetras"));
            sizeSelect.value = sopaLetras.size;
            ganadasSpan.innerHTML = sopaLetras.wins;
        }

        const sopaSize = sopaLetras.size;
        document.documentElement.style.setProperty('--cell-amount', sopaSize);

        let tablero = [];
        let palabras;
        let palabrasEncontradas = [];



        const direcciones = [
            { dx: 1, dy: 0 }, { dx: -1, dy: 0 },
            { dx: 0, dy: 1 }, { dx: 0, dy: -1 },
            { dx: 1, dy: 1 }, { dx: -1, dy: -1 },
            { dx: 1, dy: -1 }, { dx: -1, dy: 1 }
        ];
        async function iniciar() {
            palabrasULElement.innerHTML = '<li>Cargando palabras...</li>';
            palabras = await getPalabras();
            palabrasEncontradas = [];
            for (let i = 0; i < sopaSize; i++) {
                tablero[i] = [];
                for (let j = 0; j < sopaSize; j++) {
                    tablero[i][j] = "";
                }
            }

            llenarSopaDeLetras(tablero, palabras[0], sopaSize);
            llenarEspaciosVacios(tablero, sopaSize);
            dibujarTablero(tablero, tableroDiv);
            mostrarListaPalabras(palabras, palabrasULElement);
        }

        iniciar();

        // Interacci贸n
        let isDragging = false;
        let origen = { x: 0, y: 0 };
        let celdasSeleccionadas = [];

        // --- FUNCIONES LGICAS (Comunes para Mouse y Touch) ---

        function iniciarSeleccion(celda) {
            if (!celda || !celda.classList.contains('celda')) return;

            isDragging = true;
            origen = {
                x: parseInt(celda.dataset.columna),
                y: parseInt(celda.dataset.fila)
            };
            celdasSeleccionadas = [celda];
            celda.classList.add('seleccionado');
        }

        function moverSeleccion(celdaActual) {
            if (!isDragging) return;
            if (!celdaActual || !celdaActual.classList.contains('celda')) return;

            celdasSeleccionadas.forEach(c => c.classList.remove('seleccionado'));
            celdasSeleccionadas = [];

            const destino = {
                x: parseInt(celdaActual.dataset.columna),
                y: parseInt(celdaActual.dataset.fila)
            };

            const deltaX = destino.x - origen.x;
            const deltaY = destino.y - origen.y;

            let stepX = Math.sign(deltaX);
            let stepY = Math.sign(deltaY);

            if (deltaX !== 0 && deltaY !== 0 && Math.abs(deltaX) !== Math.abs(deltaY)) {
                const celdaOrigen = tableroDiv.querySelector(`.celda[data-fila='${origen.y}'][data-columna='${origen.x}']`);
                if (celdaOrigen) {
                    celdaOrigen.classList.add('seleccionado');
                    celdasSeleccionadas.push(celdaOrigen);
                }
                return;
            }

            let currentX = origen.x;
            let currentY = origen.y;
            const steps = Math.max(Math.abs(deltaX), Math.abs(deltaY));

            for (let i = 0; i <= steps; i++) {
                const celda = tableroDiv.querySelector(`.celda[data-fila='${currentY}'][data-columna='${currentX}']`);
                if (celda) {
                    celda.classList.add('seleccionado');
                    celdasSeleccionadas.push(celda);
                }
                currentX += stepX;
                currentY += stepY;
            }
        }

        function terminarSeleccion() {
            if (!isDragging) return;
            isDragging = false;
            checkPalabra();
        }

        tableroDiv.addEventListener('mousedown', (e) => iniciarSeleccion(e.target));
        tableroDiv.addEventListener('mousemove', (e) => moverSeleccion(e.target));
        window.addEventListener('mouseup', terminarSeleccion);

        tableroDiv.addEventListener('touchstart', (e) => {
            e.preventDefault();
            iniciarSeleccion(e.target);
        }, { passive: false });

        tableroDiv.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const elementoBajoDedo = document.elementFromPoint(touch.clientX, touch.clientY);
            moverSeleccion(elementoBajoDedo);
        }, { passive: false });

        window.addEventListener('touchend', terminarSeleccion);

        restartButton.onclick = function () {
            location.reload();
        }

        sizeSelect.onchange = function () {
            sopaLetras.size = sizeSelect.value;
            localStorage.setItem("sopaLetras", JSON.stringify(sopaLetras));
            location.reload();
        }



        async function getPalabras() {
            const url = `palabras.json`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Respuesta de red no v谩lida");
                const data = await response.json();

                const categoriaIndex = Math.floor(Math.random() * data.length);
                const listaSeleccionada = data[categoriaIndex];
                const palabrasObtenidas = listaSeleccionada.palabras;
                const categoria = listaSeleccionada.name;

                return [palabrasObtenidas, categoria];

            } catch (error) {
                console.log(error);
                // --- LISTAS DE PALABRAS DE RESPALDO ---
                const listasDeRespaldo = [
                    ['manzana', 'platano', 'naranja', 'fresa', 'uva', 'sandia', 'melon', 'limon', 'cereza', 'mango', 'pi帽a'],
                    ['vaca', 'cerdo', 'caballo', 'oveja', 'cabra', 'gallina', 'pato', 'conejo', 'perro', 'gato', 'toro'],
                    ['rojo', 'azul', 'verde', 'amarillo', 'naranja', 'morado', 'blanco', 'negro', 'gris', 'rosa', 'marron'],
                    ['cabeza', 'brazo', 'pierna', 'mano', 'pie', 'dedo', 'ojo', 'nariz', 'boca', 'oreja', 'espalda', 'codo'],
                    ['guitarra', 'piano', 'violin', 'bateria', 'flauta', 'trompeta', 'saxofon', 'bajo', 'arpa', 'tambor'],
                    ['planeta', 'estrella', 'galaxia', 'cometa', 'sol', 'luna', 'cohete', 'orbita', 'espacio', 'nebula', 'marte'],
                    ['camisa', 'pantalon', 'zapato', 'vestido', 'falda', 'chaqueta', 'sombrero', 'calcetin', 'guante', 'bufanda'],
                    ['silla', 'mesa', 'cama', 'sofa', 'armario', 'estante', 'lampara', 'escritorio', 'comoda', 'vitrina'],
                    ['doctor', 'bombero', 'policia', 'maestro', 'cocinero', 'juez', 'actor', 'pintor', 'musico', 'cartero'],
                    ['martillo', 'sierra', 'clavo', 'tornillo', 'taladro', 'llave', 'pinzas', 'destornillador', 'hacha', 'pala'],
                    ['lluvia', 'nieve', 'viento', 'sol', 'tormenta', 'niebla', 'granizo', 'huracan', 'tornado', 'relampago', 'trueno'],
                    ['coche', 'moto', 'autobus', 'camion', 'bicicleta', 'avion', 'barco', 'tren', 'tractor', 'helicoptero'],
                    ['lapiz', 'cuaderno', 'goma', 'regla', 'libro', 'mochila', 'tijeras', 'pegamento', 'sacapuntas', 'estuche'],
                    ['futbol', 'tenis', 'baloncesto', 'natacion', 'atletismo', 'beisbol', 'golf', 'ciclismo', 'boxeo', 'karate'],
                    ['pan', 'queso', 'arroz', 'huevo', 'carne', 'pescado', 'sopa', 'ensalada', 'pasta', 'cuchara', 'tenedor'],
                    ['rio', 'monta帽a', 'valle', 'desierto', 'oceano', 'continente', 'isla', 'lago', 'volcan', 'ciudad', 'pais'],
                    ['rueda', 'motor', 'volante', 'puerta', 'ventana', 'asiento', 'freno', 'maletero', 'parabrisas', 'espejo'],
                    ['ballena', 'tiburon', 'delfin', 'pulpo', 'cangrejo', 'estrella', 'pez', 'medusa', 'foca', 'tortuga', 'calamar'],
                    ['fuego', 'agua', 'tierra', 'aire', 'arbol', 'piedra', 'flor', 'planta', 'arena', 'bosque', 'selva'],
                    ['ordenador', 'teclado', 'raton', 'pantalla', 'codigo', 'programa', 'internet', 'software', 'hardware', 'archivo']
                ];

                return listasDeRespaldo[Math.floor(Math.random() * listasDeRespaldo.length)];
            };
        }

        function llenarSopaDeLetras(tablero, palabras, size) {
            const palabrasOrdenadas = [...palabras].sort((a, b) => b.length - a.length);
            const palabrasColocadasInfo = [];
            const palabrasQueSiCabian = [];

            for (const palabra of palabrasOrdenadas) {
                let mejorPosicion = null;
                const cruceRnd = Math.floor(Math.random() * 3);

                if (palabrasColocadasInfo.length > 0 && cruceRnd === 0) {
                    mejorPosicion = encontrarInterseccion(tablero, palabra, palabrasColocadasInfo, size);
                }

                if (!mejorPosicion) {
                    mejorPosicion = encontrarPosicionAleatoria(tablero, palabra, size);
                }

                if (mejorPosicion) {
                    colocarPalabra(tablero, palabra, mejorPosicion.x, mejorPosicion.y, mejorPosicion.direccion);
                    palabrasColocadasInfo.push({
                        text: palabra,
                        x: mejorPosicion.x,
                        y: mejorPosicion.y,
                        direccion: mejorPosicion.direccion
                    });
                    palabrasQueSiCabian.push(palabra);
                } else {
                    // Si no se encontr贸 lugar, avisar en consola y simplemente no a帽adirla a la lista final
                    console.warn(`No se pudo colocar la palabra: "${palabra}" y fue eliminada de la lista.`);
                }
            }


            palabras.length = 0;
            palabras.push(...palabrasQueSiCabian.sort()); // Se re-insertan las palabras que s铆 cupieron
        }

        function encontrarInterseccion(tablero, palabra, palabrasColocadas, size) {
            for (let i = 0; i < palabra.length; i++) {
                const letraNueva = palabra[i];
                for (const palabraPuesta of palabrasColocadas) {
                    for (let j = 0; j < palabraPuesta.text.length; j++) {
                        const letraPuesta = palabraPuesta.text[j];

                        if (letraNueva === letraPuesta) {
                            const cruceX = palabraPuesta.x + j * palabraPuesta.direccion.dx;
                            const cruceY = palabraPuesta.y + j * palabraPuesta.direccion.dy;

                            for (const direccion of direcciones) {
                                const startX = cruceX - i * direccion.dx;
                                const startY = cruceY - i * direccion.dy;

                                if (sePuedeColocar(tablero, palabra, startX, startY, direccion, size)) {
                                    return { x: startX, y: startY, direccion: direccion };
                                }
                            }
                        }
                    }
                }
            }
            return null;
        }

        function encontrarPosicionAleatoria(tablero, palabra, size) {
            const maxIntentos = 100;
            for (let i = 0; i < maxIntentos; i++) {
                const direccion = direcciones[Math.floor(Math.random() * direcciones.length)];
                const x = Math.floor(Math.random() * size);
                const y = Math.floor(Math.random() * size);

                if (sePuedeColocar(tablero, palabra, x, y, direccion, size)) {
                    return { x, y, direccion };
                }
            }
            return null;
        }

        function sePuedeColocar(tablero, palabra, startX, startY, direccion, size) {
            for (let i = 0; i < palabra.length; i++) {
                const x = startX + i * direccion.dx;
                const y = startY + i * direccion.dy;

                // 1. Comprobaci贸n de l铆mites 
                if (x < 0 || x >= size || y < 0 || y >= size) return false;

                // 2. Comprobaci贸n de colisi贸n en la ruta 
                const celda = tablero[y][x];
                if (celda !== "" && celda !== palabra[i]) return false;

                // 3. Comprobaci贸n de margen en las 8 celdas vecinas
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue; // No comprobar la celda misma

                        const checkX = x + dx;
                        const checkY = y + dy;
                        if (checkX >= 0 && checkX < size && checkY >= 0 && checkY < size) {

                            const esLetraAnterior = (checkX === x - direccion.dx) && (checkY === y - direccion.dy);
                            const esLetraSiguiente = (checkX === x + direccion.dx) && (checkY === y + direccion.dy);

                            if (!esLetraAnterior && !esLetraSiguiente && tablero[checkY][checkX] !== "") {
                                return false;
                            }
                        }
                    }
                }
            }
            return true;
        }

        function colocarPalabra(tablero, palabra, startX, startY, direccion) {
            const palabraSinAcentos = quitarAcentos(palabra.toLowerCase());
            for (let i = 0; i < palabra.length; i++) {
                const x = startX + i * direccion.dx;
                const y = startY + i * direccion.dy;
                tablero[y][x] = palabraSinAcentos[i];
            }
        }

        function llenarEspaciosVacios(tablero, size) {
            const alfabeto = "abcdefghijklmn帽opqrstuvwxyz";
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (tablero[i][j] === "") {
                        tablero[i][j] = alfabeto[Math.floor(Math.random() * alfabeto.length)];
                        //tablero[i][j] = "";
                    }
                }
            }
        }

        function dibujarTablero(tablero, container) {
            container.innerHTML = "";
            for (let i = 0; i < tablero.length; i++) {
                const filaDiv = document.createElement("div");
                filaDiv.className = "fila";
                for (let j = 0; j < tablero[i].length; j++) {
                    const celdaDiv = document.createElement("div");
                    celdaDiv.className = "celda";
                    celdaDiv.textContent = tablero[i][j];
                    celdaDiv.dataset.fila = i;
                    celdaDiv.dataset.columna = j;
                    filaDiv.appendChild(celdaDiv);
                }
                container.appendChild(filaDiv);
            }
        }

        function mostrarListaPalabras(palabrasArray, container) {
            const palabras = palabrasArray[0];
            const categoria = palabrasArray[1];
            const categoriaHeader = document.createElement("h3");
            categoriaHeader.textContent = `Categor铆a: ${categoria}`;
            container.parentElement.insertBefore(categoriaHeader, container);
            container.innerHTML = "";
            for (const palabra of palabras) {
                const li = document.createElement("li");
                li.textContent = palabra;
                li.dataset.palabra = palabra;
                li.addEventListener("click", () => {
                    getDefinicion(palabra).then(definicion => {
                        alert(`Definici贸n de "${palabra}":\n\n${definicion}`);
                    });
                })
                container.appendChild(li);
            }
        }

        function checkPalabra() {
            if (celdasSeleccionadas.length === 0) return;

            const palabraFormada = celdasSeleccionadas.map(c => c.textContent).join('');
            let palabraCorrecta = null;

            const palabrasPendientes = palabras.filter(p => !palabrasEncontradas.includes(p));

            for (const palabra of palabrasPendientes) {
                if (palabra.length !== palabraFormada.length) {
                    continue;
                }
                const palabraSinAcentos = quitarAcentos(palabra.toLowerCase());

                if (palabraSinAcentos === palabraFormada) {
                    palabraCorrecta = palabra;
                    break;
                }
                const palabraInversa = palabraFormada.split('').reverse().join('');
                if (palabraSinAcentos === palabraInversa) {
                    palabraCorrecta = palabra;
                    break;
                }
            }
            if (palabraCorrecta) {
                palabrasEncontradas.push(palabraCorrecta);
                celdasSeleccionadas.forEach(c => {
                    c.classList.remove('seleccionado');
                    c.classList.add('encontrado');
                });
                const li = palabrasULElement.querySelector(`li[data-palabra='${palabraCorrecta}']`);
                if (li) {
                    li.classList.add('encontrado-lista');
                    if (palabrasEncontradas.length === palabras.length) {
                        dialog.showModal();
                        sopaLetras.wins++;
                        ganadasSpan.innerHTML = sopaLetras.wins;
                        localStorage.setItem("sopaLetras", JSON.stringify(sopaLetras));
                    }
                }
            } else {
                celdasSeleccionadas.forEach(c => c.classList.remove('seleccionado'));
            }
            celdasSeleccionadas = [];
        }
        function quitarAcentos(texto) {
            const acentos = { '谩': 'a', '茅': 'e', '铆': 'i', '贸': 'o', '煤': 'u', '眉': 'u' };
            return texto.split('').map(letra => acentos[letra] || letra).join('');
        }
        async function getDefinicion(palabra) {
            const url = `https://rae-api.com/api/words/${encodeURIComponent(palabra)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("La red no respondi贸 correctamente.");
                const data = await response.json();

                const primeraDefinicion = data.data.meanings[0]?.senses[0].raw ? document.createTextNode(data.data.meanings[0].senses[0].raw) : null;

                if (primeraDefinicion) {
                    return primeraDefinicion.textContent.trim();
                } else {
                    return "No se encontr贸 una definici贸n para esta palabra.";
                }

            } catch (error) {
                console.error("Error al obtener la definici贸n:", error);
                return "No se pudo cargar la definici贸n.";
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado con 茅xito:', registration);
                    })
                    .catch(error => {
                        console.error('Fallo en el registro del Service Worker:', error);
                    });
            });
        }
    </script>
</body>

</html>